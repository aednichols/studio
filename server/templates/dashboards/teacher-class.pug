extends _layout

block vars
  - var title = __('Teacher Dashboard')
  - var styles = ['/dashboard.css']
  - var scripts = ['/dashboard.js']

block main
  .container
    a.back(href="/dashboard") #[x-icon(name="back")] #{__('All Classes')}
    h1
      | #{classroom.title}
      button(data-modal='edit-class'): x-icon(name="settings" size=26)

  .container.wide
    .row.padded
      .dashboard-body.grow
        +flash(messages)
        .sidebar-panel.l-hide: h2 #{__('Class code')}: #{classroom.code}

        if studentData.length
          .overflow-wrap: #roster
            //- Title Row
            .cell.title.c1= __('Student Name')
            .r
              .cell.title.c2.interactive(@click="panel='course'")
                .course-img(:style="{'background-color': course.color, 'background-image': 'url(' + course.icon + ')'}")
                | {{ course.title }}
              .popup(:class="{open: panel==='course'}")
                .popup-row(v-for="c in courses" :key="c.id" @click="course = c; panel = ''" :class="{active: course === c}")
                  .course-img(:style="{'background-color': c.color, 'background-image': 'url(' + c.icon + ')'}")
                  | {{ c.title }}
                  .progress: .bar(:style="{color: c.color, width: c.progress + '%'}")
            .r
              svg.arrow(width=15 height=32): path(d="M3 3L12 16L3 29")
              .cell.title.c3.interactive(@click="panel='section'") {{ section.title }}
              .popup.section(:class="{open: panel==='section'}")
                template(v-for="s in course.sections" :key="s.id" )
                  .popup-row.locked(v-if="s.locked") {{ s.title }}
                  .popup-row(v-else @click="section = s; panel = ''" :class="{active: section === s}")
                    | {{ s.title }}
                    .progress: .bar(:style="{color: course.color, width: s.progress + '%'}")
            .cell.title.c4= __('Weekly Time')

            //- Body Rows
            template(v-for="student in students" :key="student.id")
              .cell.c1.interactive(@click="expanded = (expanded === student.id) ? '' : student.id" :class="{open: expanded === student.id}")
                img.avatar(:src="student.avatar" alt="" width=32 height=32)
                | {{ student.name }}
                button(@click="removeStudent($event, student)" v-if="student.canRemove"): x-icon(name="delete")
              .cell.c2: .progress: .bar(:style="{color: course.color, width: student.progress[course.id].total + '%'}")
              .cell.c3: .progress: .bar(:style="{color: course.color, width: student.progress[course.id][section.id] + '%'}")
              .cell.c4 {{ student.minutes }} min
              .details(:class="{open: expanded === student.id, empty: !student.courses.length}")
                .details-wrap(v-if="student.courses.length")
                  .details-course(v-for="c in student.courses" :key="c")
                    .course-img(:style="{'background-color': courseMap[c].color, 'background-image': 'url(' + courseMap[c].icon + ')'}")
                    .course-title {{ courseMap[c].title }}
                    .course-section(v-for="s in courseMap[c].sections" :key="s.id")
                      x-progress(r=8 :p="student.progress[c][s.id]/100")
                      | {{ s.title }}
                .no-courses(v-else)
                  x-icon(name="tools-2" size=40)
                  | #{__('This student has not yet started any courses.')}

          script#student-data(type="application/json")!= JSON.stringify(studentData)
          script#course-data(type="application/json")!= JSON.stringify(courseData)

          x-modal#remove-student(style="width: 440px")
            button.close: x-icon(name="close")
            .modal-body
              h2 #[x-icon(name="delete" size=32)] #{__('Remove Student')}
              form.form-large(action=`/dashboard/${classroom.code}/remove/xxx` method="POST")
                p!= __('Are you sure you want to remove $0 from your teacher dashboard? To revert this action, they will have to add your class code again on their student dashboard.', '<strong></strong>')
                p!= __('$0 will continue to be able to use their Mathigon account independently. Please ensure that they have any required parent or guardian consent to do so.', '<strong></strong>')
                input(type="hidden" name="_csrf" value=_csrf)
                p.btn-row: button.btn.btn-red(type='submit')= __('Remove')

        else
          .empty-dashboard
            x-icon(name="tools-2" size=120)
            p= __('No students have joined this class yet.')

      .dashboard-sidebar: .sidebar-wrap
        a.sidebar-panel.red(href=`/dashboard/${classroom.code}/polypad`)= __('Polypad Dashboard')
        a.sidebar-panel.green(href=`/dashboard/${classroom.code}/multiply`)=  __('Multiplication Dashboard')
        a.sidebar-panel.yellow(href='https://community.mathigon.org' target="_blank")=  __('Community Forum')
        .sidebar-panel
          h2= __('Add Students')
          p!= __('New students can join your class by using the code $0 when signing up for Mathigon. If they already have an account, they can click “Add Class Code” in the sidebar of their student dashboard.', `<strong>${classroom.code}</strong>`)
          p= __('It is your responsibility to obtain any necessary parental consent before asking students to sign up.')
          p
            img(src="https://www.gstatic.com/classroom/logo_square_48.svg" alt="Google Classroom" width=24 height=24 style="margin: -3px 6px 0 0")
            a(href=`/auth/classroom/${classroom.code}`)= __('Import from Google Classroom')

        +socialPanel()

    x-modal#edit-class
      button.close: x-icon(name="close")
      .modal-body
        h2 #[x-icon(name="settings" size=32)] #{__('Class settings')}
        form(method="POST")
          input(type="hidden" name="_csrf" value=_csrf)
          label.form-field
            input(name="title" type="text" placeholder="Class name" value=classroom.title required maxlength=30)
            span(class="placeholder")= __('Class name')
          p.btn-row
            button.btn.btn-red(type="button" data-modal="delete-class")= __('Delete class')
            button.btn.btn-blue(type="submit")= __('Save changes')

    x-modal#delete-class
      button.close: x-icon(name="close")
      .modal-body
        h2 #[x-icon(name="delete" size=32)] #{__('Delete class')}
        form(action=`/dashboard/${classroom.code}/delete` method="POST")
          p= __('Are you sure you want to delete this class? It is not possible to restore a class once deleted. Deleting a class won’t delete the Mathigon accounts of students within that class.')
          input(type="hidden" name="_csrf" value=_csrf)
          p.btn-row
            button.btn.btn-red(type="submit")= __('Delete class')

    if googleClassroomCourses
      x-modal#classroom.open
        button.close: x-icon(name="close")
        .modal-body
          h2 #[img(src="https://www.gstatic.com/classroom/logo_square_48.svg" width=36 height=36 style="margin: -6px 8px 0 0" alt="Google Classroom")] #{__('Import Student Roster')}
          p= __('Select one of the courses below to import its student roster from Google Classroom. We will create a new Mathigon account for all students that don’t already have one, and send them a confirmation email. Students that are already part of this class will be skipped.')
          for c in googleClassroomCourses
            a.classroom-link(href=`/auth/classroom/course/${c.id}`)= c.name

    include _footer
